<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />

	<title>Class: Rack::Sendfile</title>

	<link rel="stylesheet" href="../rdoc.css" type="text/css" media="screen" />

	<script src="../js/jquery.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="../js/thickbox-compressed.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="../js/quicksearch.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="../js/darkfish.js" type="text/javascript"
		charset="utf-8"></script>

</head>
<body class="class">

	<div id="metadata">
		<div id="home-metadata">
			<div id="home-section" class="section">
        <h3 class="section-header">
          <a href="../index.html">Home</a>
          <a href="../index.html#classes">Classes</a>
          <a href="../index.html#methods">Methods</a>
        </h3>
			</div>
		</div>

		<div id="file-metadata">
			<div id="file-list-section" class="section">
				<h3 class="section-header">In Files</h3>
				<div class="section-body">
					<ul>
					
						<li><a href="../lib/rack/sendfile_rb.html?TB_iframe=true&amp;height=550&amp;width=785"
							class="thickbox" title="lib/rack/sendfile.rb">lib/rack/sendfile.rb</a></li>
					
					</ul>
				</div>
			</div>

			
		</div>

		<div id="class-metadata">

			<!-- Parent Class -->
			
			<div id="parent-class-section" class="section">
				<h3 class="section-header">Parent</h3>
				
				<p class="link">Object</p>
				
			</div>
			

			<!-- Namespace Contents -->
			

			<!-- Method Quickref -->
			
			<div id="method-list-section" class="section">
				<h3 class="section-header">Methods</h3>
				<ul class="link-list">
					
					<li><a href="#M000305">::new</a></li>
					
					<li><a href="#M000306">#call</a></li>
					
					<li><a href="#M000308">#map_accel_path</a></li>
					
					<li><a href="#M000307">#variation</a></li>
					
				</ul>
			</div>
			

			<!-- Included Modules -->
			
		</div>

		<div id="project-metadata">
			
			

			<div id="classindex-section" class="section project-section">
				<h3 class="section-header">Class Index
					<span class="search-toggle"><img src="../images/find.png"
						height="16" width="16" alt="[+]"
						title="show/hide quicksearch" /></span></h3>
				<form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
				<fieldset>
					<legend>Quicksearch</legend>
					<input type="text" name="quicksearch" value=""
						class="quicksearch-field" />
				</fieldset>
				</form>

				<ul class="link-list">
				
					<li><a href="../Rack.html">Rack</a></li>
				
					<li><a href="../Rack/Auth.html">Rack::Auth</a></li>
				
					<li><a href="../Rack/Auth/AbstractHandler.html">Rack::Auth::AbstractHandler</a></li>
				
					<li><a href="../Rack/Auth/AbstractRequest.html">Rack::Auth::AbstractRequest</a></li>
				
					<li><a href="../Rack/Auth/Basic.html">Rack::Auth::Basic</a></li>
				
					<li><a href="../Rack/Auth/Basic/Request.html">Rack::Auth::Basic::Request</a></li>
				
					<li><a href="../Rack/Auth/Digest.html">Rack::Auth::Digest</a></li>
				
					<li><a href="../Rack/Auth/Digest/MD5.html">Rack::Auth::Digest::MD5</a></li>
				
					<li><a href="../Rack/Auth/Digest/Nonce.html">Rack::Auth::Digest::Nonce</a></li>
				
					<li><a href="../Rack/Auth/Digest/Params.html">Rack::Auth::Digest::Params</a></li>
				
					<li><a href="../Rack/Auth/Digest/Request.html">Rack::Auth::Digest::Request</a></li>
				
					<li><a href="../Rack/Builder.html">Rack::Builder</a></li>
				
					<li><a href="../Rack/Cascade.html">Rack::Cascade</a></li>
				
					<li><a href="../Rack/Chunked.html">Rack::Chunked</a></li>
				
					<li><a href="../Rack/Chunked/Body.html">Rack::Chunked::Body</a></li>
				
					<li><a href="../Rack/CommonLogger.html">Rack::CommonLogger</a></li>
				
					<li><a href="../Rack/ConditionalGet.html">Rack::ConditionalGet</a></li>
				
					<li><a href="../Rack/Config.html">Rack::Config</a></li>
				
					<li><a href="../Rack/ContentLength.html">Rack::ContentLength</a></li>
				
					<li><a href="../Rack/ContentType.html">Rack::ContentType</a></li>
				
					<li><a href="../Rack/Deflater.html">Rack::Deflater</a></li>
				
					<li><a href="../Rack/Deflater/DeflateStream.html">Rack::Deflater::DeflateStream</a></li>
				
					<li><a href="../Rack/Deflater/GzipStream.html">Rack::Deflater::GzipStream</a></li>
				
					<li><a href="../Rack/Directory.html">Rack::Directory</a></li>
				
					<li><a href="../Rack/ETag.html">Rack::ETag</a></li>
				
					<li><a href="../Rack/File.html">Rack::File</a></li>
				
					<li><a href="../Rack/ForwardRequest.html">Rack::ForwardRequest</a></li>
				
					<li><a href="../Rack/Handler.html">Rack::Handler</a></li>
				
					<li><a href="../Rack/Handler/CGI.html">Rack::Handler::CGI</a></li>
				
					<li><a href="../Rack/Handler/EventedMongrel.html">Rack::Handler::EventedMongrel</a></li>
				
					<li><a href="../Rack/Handler/FastCGI.html">Rack::Handler::FastCGI</a></li>
				
					<li><a href="../Rack/Handler/LSWS.html">Rack::Handler::LSWS</a></li>
				
					<li><a href="../Rack/Handler/Mongrel.html">Rack::Handler::Mongrel</a></li>
				
					<li><a href="../Rack/Handler/SCGI.html">Rack::Handler::SCGI</a></li>
				
					<li><a href="../Rack/Handler/SwiftipliedMongrel.html">Rack::Handler::SwiftipliedMongrel</a></li>
				
					<li><a href="../Rack/Handler/Thin.html">Rack::Handler::Thin</a></li>
				
					<li><a href="../Rack/Handler/WEBrick.html">Rack::Handler::WEBrick</a></li>
				
					<li><a href="../Rack/Head.html">Rack::Head</a></li>
				
					<li><a href="../Rack/Lint.html">Rack::Lint</a></li>
				
					<li><a href="../Rack/Lobster.html">Rack::Lobster</a></li>
				
					<li><a href="../Rack/Lock.html">Rack::Lock</a></li>
				
					<li><a href="../Rack/Logger.html">Rack::Logger</a></li>
				
					<li><a href="../Rack/MethodOverride.html">Rack::MethodOverride</a></li>
				
					<li><a href="../Rack/Mime.html">Rack::Mime</a></li>
				
					<li><a href="../Rack/MockRequest.html">Rack::MockRequest</a></li>
				
					<li><a href="../Rack/MockRequest/FatalWarner.html">Rack::MockRequest::FatalWarner</a></li>
				
					<li><a href="../Rack/MockRequest/FatalWarning.html">Rack::MockRequest::FatalWarning</a></li>
				
					<li><a href="../Rack/MockResponse.html">Rack::MockResponse</a></li>
				
					<li><a href="../Rack/Multipart.html">Rack::Multipart</a></li>
				
					<li><a href="../Rack/Multipart.html">Rack::Multipart</a></li>
				
					<li><a href="../Rack/Multipart/Generator.html">Rack::Multipart::Generator</a></li>
				
					<li><a href="../Rack/Multipart/Parser.html">Rack::Multipart::Parser</a></li>
				
					<li><a href="../Rack/Multipart/UploadedFile.html">Rack::Multipart::UploadedFile</a></li>
				
					<li><a href="../Rack/NullLogger.html">Rack::NullLogger</a></li>
				
					<li><a href="../Rack/Recursive.html">Rack::Recursive</a></li>
				
					<li><a href="../Rack/Reloader.html">Rack::Reloader</a></li>
				
					<li><a href="../Rack/Reloader/Stat.html">Rack::Reloader::Stat</a></li>
				
					<li><a href="../Rack/Request.html">Rack::Request</a></li>
				
					<li><a href="../Rack/Response.html">Rack::Response</a></li>
				
					<li><a href="../Rack/Response/Helpers.html">Rack::Response::Helpers</a></li>
				
					<li><a href="../Rack/RewindableInput.html">Rack::RewindableInput</a></li>
				
					<li><a href="../Rack/RewindableInput/Tempfile.html">Rack::RewindableInput::Tempfile</a></li>
				
					<li><a href="../Rack/Runtime.html">Rack::Runtime</a></li>
				
					<li><a href="../Rack/Sendfile.html">Rack::Sendfile</a></li>
				
					<li><a href="../Rack/Server.html">Rack::Server</a></li>
				
					<li><a href="../Rack/Server/Options.html">Rack::Server::Options</a></li>
				
					<li><a href="../Rack/Session.html">Rack::Session</a></li>
				
					<li><a href="../Rack/Session/Abstract.html">Rack::Session::Abstract</a></li>
				
					<li><a href="../Rack/Session/Abstract/ID.html">Rack::Session::Abstract::ID</a></li>
				
					<li><a href="../Rack/Session/Abstract/SessionHash.html">Rack::Session::Abstract::SessionHash</a></li>
				
					<li><a href="../Rack/Session/Cookie.html">Rack::Session::Cookie</a></li>
				
					<li><a href="../Rack/Session/Cookie/Base64.html">Rack::Session::Cookie::Base64</a></li>
				
					<li><a href="../Rack/Session/Cookie/Base64/Marshal.html">Rack::Session::Cookie::Base64::Marshal</a></li>
				
					<li><a href="../Rack/Session/Cookie/Identity.html">Rack::Session::Cookie::Identity</a></li>
				
					<li><a href="../Rack/Session/Cookie/Reverse.html">Rack::Session::Cookie::Reverse</a></li>
				
					<li><a href="../Rack/Session/Memcache.html">Rack::Session::Memcache</a></li>
				
					<li><a href="../Rack/Session/Pool.html">Rack::Session::Pool</a></li>
				
					<li><a href="../Rack/ShowExceptions.html">Rack::ShowExceptions</a></li>
				
					<li><a href="../Rack/ShowStatus.html">Rack::ShowStatus</a></li>
				
					<li><a href="../Rack/Static.html">Rack::Static</a></li>
				
					<li><a href="../Rack/URLMap.html">Rack::URLMap</a></li>
				
					<li><a href="../Rack/Utils.html">Rack::Utils</a></li>
				
					<li><a href="../Rack/Utils/Context.html">Rack::Utils::Context</a></li>
				
					<li><a href="../Rack/Utils/HeaderHash.html">Rack::Utils::HeaderHash</a></li>
				
					<li><a href="../FCGI.html">FCGI</a></li>
				
					<li><a href="../FCGI/Stream.html">FCGI::Stream</a></li>
				
				</ul>
				<div id="no-class-search-results" style="display: none;">No matching classes.</div>
			</div>

			
		</div>
	</div>

	<div id="documentation">
		<h1 class="class">Rack::Sendfile</h1>

		<div id="description">
			<h1><a href="Sendfile.html">Sendfile</a></h1>
<p>
The <a href="Sendfile.html">Sendfile</a> middleware intercepts responses
whose body is being served from a file and replaces it with a server
specific X-<a href="Sendfile.html">Sendfile</a> header. The web server is
then responsible for writing the file contents to the client. This can
dramatically reduce the amount of work required by the Ruby backend and
takes advantage of the web server&#8217;s optimized file delivery code.
</p>
<p>
In order to take advantage of this middleware, the response body must
respond to <tt>to_path</tt> and the request must include an X-Sendfile-Type
header. <a href="File.html">Rack::File</a> and other components implement
<tt>to_path</tt> so there&#8217;s rarely anything you need to do in your
application. The X-Sendfile-Type header is typically set in your web
servers configuration. The following sections attempt to document
</p>
<h3>Nginx</h3>
<p>
Nginx supports the X-Accel-Redirect header. This is similar to X-<a
href="Sendfile.html">Sendfile</a> but requires parts of the filesystem to
be mapped into a private URL hierarachy.
</p>
<p>
The following example shows the Nginx configuration required to create a
private &#8220;/files/&#8221; area, enable X-Accel-Redirect, and pass the
special X-Sendfile-Type and X-Accel-Mapping headers to the backend:
</p>
<pre>
  location ~ /files/(.*) {
    internal;
    alias /var/www/$1;
  }

  location / {
    proxy_redirect     off;

    proxy_set_header   Host                $host;
    proxy_set_header   X-Real-IP           $remote_addr;
    proxy_set_header   X-Forwarded-For     $proxy_add_x_forwarded_for;

    proxy_set_header   X-Sendfile-Type     X-Accel-Redirect;
    proxy_set_header   X-Accel-Mapping     /var/www/=/files/;

    proxy_pass         http://127.0.0.1:8080/;
  }
</pre>
<p>
Note that the X-Sendfile-Type header must be set exactly as shown above.
The X-Accel-Mapping header should specify the by the location on the file
system, followed by an equals sign (=), followed name of the private URL
pattern that it maps to. The middleware performs a simple substitution on
the resulting path.
</p>
<p>
See Also: <a
href="http://wiki.codemongers.com/NginxXSendfile">wiki.codemongers.com/NginxXSendfile</a>
</p>
<h3>lighttpd</h3>
<p>
Lighttpd has supported some variation of the X-<a
href="Sendfile.html">Sendfile</a> header for some time, although only
recent version support X-<a href="Sendfile.html">Sendfile</a> in a reverse
proxy configuration.
</p>
<pre>
  $HTTP[&quot;host&quot;] == &quot;example.com&quot; {
     proxy-core.protocol = &quot;http&quot;
     proxy-core.balancer = &quot;round-robin&quot;
     proxy-core.backends = (
       &quot;127.0.0.1:8000&quot;,
       &quot;127.0.0.1:8001&quot;,
       ...
     )

     proxy-core.allow-x-sendfile = &quot;enable&quot;
     proxy-core.rewrite-request = (
       &quot;X-Sendfile-Type&quot; =&gt; (&quot;.*&quot; =&gt; &quot;X-Sendfile&quot;)
     )
   }
</pre>
<p>
See Also: <a
href="http://redmine.lighttpd.net/wiki/lighttpd/Docs:ModProxyCore">redmine.lighttpd.net/wiki/lighttpd/Docs:ModProxyCore</a>
</p>
<h3>Apache</h3>
<p>
X-<a href="Sendfile.html">Sendfile</a> is supported under Apache 2.x using
a separate module:
</p>
<p>
<a
href="http://tn123.ath.cx/mod_xsendfile/">tn123.ath.cx/mod_xsendfile/</a>
</p>
<p>
Once the module is compiled and installed, you can enable it using
XSendFile config directive:
</p>
<pre>
  RequestHeader Set X-Sendfile-Type X-Sendfile
  ProxyPassReverse / http://localhost:8001/
  XSendFile on</pre>

		</div>

		<!-- Constants -->
		
		<div id="constants-list" class="section">
			<h3 class="section-header">Constants</h3>
			<dl>
			
				<dt><a name="F">F</a></dt>
				
				<dd class="description"></dd>
				
			
			</dl>
		</div>
		

		<!-- Attributes -->
		

		<!-- Methods -->
		
		<div id="private-instance-method-details" class="method-section section">
			<h3 class="section-header">Private Instance Methods</h3>

		
			<div id="map-accel-path-method" class="method-detail ">
				<a name="M000308"></a>

				<div class="method-heading">
				
					<span class="method-name">map_accel_path</span><span
						class="method-args">(env, file)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="map-accel-path-source">
<pre>
     <span class="ruby-comment cmt"># File lib/rack/sendfile.rb, line 133</span>
133:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">map_accel_path</span>(<span class="ruby-identifier">env</span>, <span class="ruby-identifier">file</span>)
134:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">mapping</span> = <span class="ruby-identifier">env</span>[<span class="ruby-value str">'HTTP_X_ACCEL_MAPPING'</span>]
135:         <span class="ruby-identifier">internal</span>, <span class="ruby-identifier">external</span> = <span class="ruby-identifier">mapping</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">'='</span>, <span class="ruby-value">2</span>).<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">strip</span> }
136:         <span class="ruby-identifier">file</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-node">/^#{internal}/</span>, <span class="ruby-identifier">external</span>)
137:       <span class="ruby-keyword kw">end</span>
138:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
			<div id="variation-method" class="method-detail ">
				<a name="M000307"></a>

				<div class="method-heading">
				
					<span class="method-name">variation</span><span
						class="method-args">(env)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="variation-source">
<pre>
     <span class="ruby-comment cmt"># File lib/rack/sendfile.rb, line 127</span>
127:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">variation</span>(<span class="ruby-identifier">env</span>)
128:       <span class="ruby-ivar">@variation</span> <span class="ruby-operator">||</span>
129:         <span class="ruby-identifier">env</span>[<span class="ruby-value str">'sendfile.type'</span>] <span class="ruby-operator">||</span>
130:         <span class="ruby-identifier">env</span>[<span class="ruby-value str">'HTTP_X_SENDFILE_TYPE'</span>]
131:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
		</div>
	
		<div id="public-instance-method-details" class="method-section section">
			<h3 class="section-header">Public Instance Methods</h3>

		
			<div id="call-method" class="method-detail ">
				<a name="M000306"></a>

				<div class="method-heading">
				
					<span class="method-name">call</span><span
						class="method-args">(env)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="call-source">
<pre>
     <span class="ruby-comment cmt"># File lib/rack/sendfile.rb, line 101</span>
101:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">call</span>(<span class="ruby-identifier">env</span>)
102:       <span class="ruby-identifier">status</span>, <span class="ruby-identifier">headers</span>, <span class="ruby-identifier">body</span> = <span class="ruby-ivar">@app</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">env</span>)
103:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_path</span>)
104:         <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">type</span> = <span class="ruby-identifier">variation</span>(<span class="ruby-identifier">env</span>)
105:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'X-Accel-Redirect'</span>
106:           <span class="ruby-identifier">path</span> = <span class="ruby-constant">F</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">body</span>.<span class="ruby-identifier">to_path</span>)
107:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">url</span> = <span class="ruby-identifier">map_accel_path</span>(<span class="ruby-identifier">env</span>, <span class="ruby-identifier">path</span>)
108:             <span class="ruby-identifier">headers</span>[<span class="ruby-identifier">type</span>] = <span class="ruby-identifier">url</span>
109:             <span class="ruby-identifier">body</span> = []
110:           <span class="ruby-keyword kw">else</span>
111:             <span class="ruby-identifier">env</span>[<span class="ruby-value str">'rack.errors'</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;X-Accel-Mapping header missing&quot;</span>
112:           <span class="ruby-keyword kw">end</span>
113:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'X-Sendfile'</span>, <span class="ruby-value str">'X-Lighttpd-Send-File'</span>
114:           <span class="ruby-identifier">path</span> = <span class="ruby-constant">F</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">body</span>.<span class="ruby-identifier">to_path</span>)
115:           <span class="ruby-identifier">headers</span>[<span class="ruby-value str">'Content-Length'</span>] = <span class="ruby-value str">'0'</span>
116:           <span class="ruby-identifier">headers</span>[<span class="ruby-identifier">type</span>] = <span class="ruby-identifier">path</span>
117:           <span class="ruby-identifier">body</span> = []
118:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">''</span>, <span class="ruby-keyword kw">nil</span>
119:         <span class="ruby-keyword kw">else</span>
120:           <span class="ruby-identifier">env</span>[<span class="ruby-value str">'rack.errors'</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Unknown x-sendfile variation: '#{variation}'.\n&quot;</span>
121:         <span class="ruby-keyword kw">end</span>
122:       <span class="ruby-keyword kw">end</span>
123:       [<span class="ruby-identifier">status</span>, <span class="ruby-identifier">headers</span>, <span class="ruby-identifier">body</span>]
124:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
		</div>
	
		<div id="public-class-method-details" class="method-section section">
			<h3 class="section-header">Public Class Methods</h3>

		
			<div id="new-method" class="method-detail ">
				<a name="M000305"></a>

				<div class="method-heading">
				
					<span class="method-name">new</span><span
						class="method-args">(app, variation=nil)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					
					

					
					<div class="method-source-code"
						id="new-source">
<pre>
    <span class="ruby-comment cmt"># File lib/rack/sendfile.rb, line 96</span>
96:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">variation</span>=<span class="ruby-keyword kw">nil</span>)
97:       <span class="ruby-ivar">@app</span> = <span class="ruby-identifier">app</span>
98:       <span class="ruby-ivar">@variation</span> = <span class="ruby-identifier">variation</span>
99:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				

				
			</div>

		
		</div>
	

	</div>


	<div id="rdoc-debugging-section-dump" class="debugging-section">
	
		<p>Disabled; run with --debug to generate this.</p>
	
	</div>

	<div id="validator-badges">
		<p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
		<p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
			Rdoc Generator</a> 1.1.6</small>.</p>
	</div>

</body>
</html>

